<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teacher Tools ‚Äî Modern Dashboard</title>

  <!-- jQuery & jQuery UI -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    :root{
      --bg: linear-gradient(180deg,#f6fbff,#eef7ff);
      --panel-bg: #ffffff;
      --muted: #6b7280;
      --accent-1: #7c3aed; /* purple */
      --accent-2: #06b6d4; /* teal */
      --card-shadow: 0 8px 30px rgba(15,23,42,0.08);
      --radius: 14px;
      --toolbar-height: 70px;
      --ui-font: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    html,body{ height:100%; margin:0; font-family:var(--ui-font); font-size:16px; background:var(--bg); color:#0f172a; }

    /* Top navigation / toolbar */
    .topbar{
      height:var(--toolbar-height);
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 18px;
      backdrop-filter: blur(6px);
      position:sticky;
      top:0;
      z-index:400;
    }

    .logo {
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 12px;
      border-radius:12px;
      background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.08));
      box-shadow: var(--card-shadow);
      margin-right:6px;
    }
    .logo .name { font-weight:700; letter-spacing:0.2px; }
    .spacer { flex:1; }

    .toolbar-btn {
      appearance:none;
      border:none;
      background:linear-gradient(90deg,#ffffff, #f8fbff);
      padding:10px 14px;
      border-radius:999px;
      box-shadow: 0 4px 12px rgba(15,23,42,0.06);
      cursor:pointer;
      font-weight:600;
      color:#0f172a;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .toolbar-btn:active{ transform:translateY(1px); }
    .primary {
      background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
      color:white;
      box-shadow: 0 8px 30px rgba(6, 182, 212, 0.12);
    }

    .toolbar-controls { display:flex; gap:10px; align-items:center; }

    /* CSV manager small area */
    .csv-area {
      display:flex; gap:8px; align-items:center; background: white; padding:6px 8px; border-radius:10px;
      box-shadow: 0 6px 20px rgba(15,23,42,0.04);
    }
    .csv-area input{ padding:8px 10px; border-radius:8px; border:1px solid #e6eef9; width:160px; }
    .csv-area select{ padding:8px 10px; border-radius:8px; border:1px solid #e6eef9; }

    /* Widgets area (page) */
    .stage {
      padding:20px;
      min-height: calc(100vh - var(--toolbar-height));
      position:relative;
      overflow: auto;
    }

    .widget {
      position:absolute;
      width:320px;
      min-width:220px;
      background:var(--panel-bg);
      border-radius:var(--radius);
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(15,23,42,0.04);
      overflow:visible;
      user-select: none;
    }

    .widget-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:12px 12px 0 0;
      background: linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.08));
      cursor: move;
    }
    .widget-title { font-weight:700; font-size:14px; color:#06202b; }
    .widget-controls { display:flex; gap:8px; align-items:center; }

    .icon-btn {
      border:none; background:transparent; padding:6px; border-radius:8px; cursor:pointer; color:#06202b;
    }
    .close-btn { background: #fee2e2; color:#991b1b; padding:6px 8px; border-radius:8px; font-weight:700; }

    .widget-body { padding:12px; color:#0f172a; font-size:0.95rem; }

    /* Sticky note style */
    .sticky-note {
      width:220px; min-height:140px; padding:10px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.08);
      overflow:auto; resize: both; border: 1px solid rgba(0,0,0,0.06);
    }

    .controls-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .small-muted { color:var(--muted); font-size:0.85rem; }

    /* rounded inputs */
    input[type="text"], input[type="number"], select {
      padding:8px 10px; border-radius:10px; border:1px solid #e8f0ff; outline:none;
      background: #fbfdff;
      font-size:0.95rem;
    }

    button.pill { padding:8px 10px; border-radius:999px; border:none; cursor:pointer; background:#fff; box-shadow:0 6px 20px rgba(2,6,23,0.04); }

    /* responsive tweaks */
    @media (max-width:720px){
      .widget{ width:90%; left:6%; right:6%; }
      .logo .name { display:none; }
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="logo">
      <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#7c3aed,#06b6d4);display:flex;align-items:center;justify-content:center;color:white;font-weight:800">TT</div>
      <div>
        <div class="name">Teacher Tools</div>
        <div class="small-muted" style="font-size:12px">Classroom dashboard</div>
      </div>
    </div>

    <!-- left actions -->
    <div class="toolbar-controls">
      <button class="toolbar-btn" onclick="spawnStickyPicker()">‚ûï Sticky</button>
      <button class="toolbar-btn" onclick="spawnStopwatch()">‚è± Stopwatch</button>
      <button class="toolbar-btn" onclick="spawnTimeUntil()">üïí Time-Until</button>
      <button class="toolbar-btn" onclick="spawnDice()">üé≤ Dice</button>
      <button class="toolbar-btn" onclick="spawnStudentPicker()">üéØ Student Picker</button>
    </div>

    <div class="spacer"></div>

    <!-- right actions -->
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="toolbar-btn primary" onclick="window.open('https://script.google.com/macros/s/AKfycbzBXmIoTIx9gOI2OSRTln14EBfCN098SJjVf2dV4uiCMGGVyNQ1ZMlsuzrg2VxGMgM-/exec?page=Dashboard','_blank')">Open Dashboard</button>

      <!-- font size controls -->
      <div style="display:flex; gap:6px; align-items:center;">
        <button class="toolbar-btn" onclick="decreaseFont()">A-</button>
        <button class="toolbar-btn" onclick="increaseFont()">A+</button>
      </div>

      <!-- CSV manager compact -->
      <div class="csv-area" title="Add CSV filename (e.g. period1.csv), then Load CSVs">
        <input id="csvFilename" placeholder="period1.csv" />
        <button class="pill" onclick="addCSV()">Add</button>
        <button class="pill" onclick="loadCSVFiles()">Load</button>
        <select id="csvSelect"></select>
      </div>
    </div>
  </div>

  <div class="stage" id="stage"></div>

<script>
/* ========= GLOBAL STATE ========= */
let widgetCount = 0;
let zTop = 100;
let rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize) || 16;
const stage = document.getElementById('stage');

let csvFilenames = JSON.parse(localStorage.getItem('dashboard_csv_filenames') || '["period1.csv","period2.csv","period3.csv"]');
let classLists = {}; // loaded CSV content keyed by filename

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('csvFilename').value = csvFilenames[0] || '';
  populateCSVSelect();
});

/* ========= UTIL: create widget ========= */
function createWidget(title){
  widgetCount++;
  const id = 'w' + widgetCount;
  const wrapper = document.createElement('div');
  wrapper.className = 'widget';
  wrapper.id = id;
  wrapper.style.left = (40 + widgetCount*18) + 'px';
  wrapper.style.top = (80 + widgetCount*12) + 'px';
  wrapper.style.zIndex = ++zTop;
  wrapper.innerHTML = `
    <div class="widget-header">
      <div class="widget-title">${title}</div>
      <div class="widget-controls">
        <button class="icon-btn" onclick="toggleMin('${id}')">‚Äî</button>
        <button class="close-btn" onclick="closeWidget('${id}')">‚úï</button>
      </div>
    </div>
    <div class="widget-body"></div>
  `;
  stage.appendChild(wrapper);

  // make draggable + resizable (jQuery UI)
  $(wrapper).draggable({ handle: ".widget-header", containment: "window", start: () => bringToFront(id) }).resizable({ minHeight: 80, minWidth: 220 });

  wrapper.addEventListener('mousedown', ()=> bringToFront(id));
  return wrapper.querySelector('.widget-body');
}

function bringToFront(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.zIndex = ++zTop;
}
function closeWidget(id){
  const el = document.getElementById(id);
  if(el) el.remove();
}
function toggleMin(id){
  const el = document.getElementById(id);
  if(!el) return;
  const body = el.querySelector('.widget-body');
  body.style.display = (body.style.display === 'none') ? '' : 'none';
}

/* ========= FONT SIZE CONTROLS ========= */
function increaseFont(){
  rootFontSize = Math.min(24, rootFontSize + 1);
  document.documentElement.style.fontSize = rootFontSize + 'px';
}
function decreaseFont(){
  rootFontSize = Math.max(12, rootFontSize - 1);
  document.documentElement.style.fontSize = rootFontSize + 'px';
}

/* ========= CSV Management ========= */
function populateCSVSelect(){
  const sel = document.getElementById('csvSelect');
  sel.innerHTML = '';
  csvFilenames.forEach(fn=>{
    const opt = document.createElement('option');
    opt.value = fn;
    opt.textContent = fn;
    sel.appendChild(opt);
  });
}
function addCSV(){
  const val = document.getElementById('csvFilename').value.trim();
  if(!val) return alert('Enter a filename (e.g. period1.csv)');
  if(!csvFilenames.includes(val)) csvFilenames.push(val);
  localStorage.setItem('dashboard_csv_filenames', JSON.stringify(csvFilenames));
  populateCSVSelect();
  alert('Added ' + val + ' ‚Äî click Load to fetch from repo root.');
}
async function loadCSVFiles(){
  classLists = {};
  const failures = [];
  for(const fn of csvFilenames){
    try{
      const r = await fetch(fn);
      if(!r.ok){ failures.push(fn); continue; }
      const txt = await r.text();
      const rows = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      classLists[fn] = rows;
    }catch(e){
      failures.push(fn);
    }
  }
  populateCSVSelect();
  const loaded = Object.keys(classLists);
  if(loaded.length === 0){
    alert('No CSVs loaded. Ensure files are in repo root and publicly accessible. Default: period1.csv,...');
  } else {
    alert('Loaded: ' + loaded.join(', '));
  }
}

/* ========= STICKY NOTES ========= */
const NOTE_COLORS = [
  {name:'Sun', css:'#fff8b6'},
  {name:'Rose', css:'#ffd6e0'},
  {name:'Mint', css:'#dfffe0'},
  {name:'Sky', css:'#dbeeff'},
  {name:'Lavender', css:'#f0e6ff'}
];
function spawnStickyPicker(){
  const body = createWidget('Sticky Notes');
  const colorButtons = NOTE_COLORS.map(c => `<button class="pill" style="background:${c.css}" onclick="spawnStickyNote('${c.css}')">${c.name}</button>`).join(' ');
  body.innerHTML = `
    <div class="small-muted">Choose a color to create a sticky note.</div>
    <div class="controls-row" style="margin-top:10px">${colorButtons}</div>
    <div class="small-muted" style="margin-top:8px">Notes are movable and resizable. They do not persist yet.</div>
  `;
}
function spawnStickyNote(bg){
  // create a lightweight free-floating sticky element instead of a widget wrapper
  const sticky = document.createElement('div');
  sticky.className = 'sticky-note';
  sticky.contentEditable = 'true';
  sticky.style.background = bg;
  sticky.style.position = 'absolute';
  sticky.style.left = (60 + widgetCount*18) + 'px';
  sticky.style.top = (120 + widgetCount*10) + 'px';
  sticky.style.zIndex = ++zTop;
  sticky.innerHTML = 'Tap to edit...';
  document.body.appendChild(sticky);
  $(sticky).draggable({ containment: "window" }).resizable({ handles: "n, e, s, w, ne, se, sw, nw", minHeight:80, minWidth:100 });
  // add right-click context to remove
  sticky.addEventListener('contextmenu', (e)=> { e.preventDefault(); if(confirm('Delete this note?')) sticky.remove(); });
}

/* ========= STOPWATCH (per-widget state) ========= */
const stopwatches = {}; // keyed by widget id
function spawnStopwatch(){
  const body = createWidget('Stopwatch');
  const wid = body.parentElement.id;
  body.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <div id="${wid}_display" style="font-weight:800;font-size:1.15rem">00:00.000</div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="pill" onclick="sw_start('${wid}')">Start</button>
        <button class="pill" onclick="sw_stop('${wid}')">Stop</button>
        <button class="pill" onclick="sw_reset('${wid}')">Reset</button>
      </div>
    </div>
    <div class="small-muted" style="margin-top:8px">Each stopwatch is independent.</div>
  `;
  // initialize state
  stopwatches[wid] = {interval: null, startTs: 0, acc: 0};
}
function sw_updateDisplay(wid, ms){
  const el = document.getElementById(wid + '_display');
  if(!el) return;
  const total = ms;
  const minutes = Math.floor(total/60000);
  const seconds = Math.floor((total%60000)/1000);
  const millis = total % 1000;
  el.textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(millis).padStart(3,'0')}`;
}
function sw_start(wid){
  const s = stopwatches[wid];
  if(!s) return;
  if(s.interval) return;
  s.startTs = performance.now();
  s.interval = setInterval(()=>{
    const now = performance.now();
    const elapsed = s.acc + Math.floor(now - s.startTs);
    sw_updateDisplay(wid, elapsed);
  }, 30);
}
function sw_stop(wid){
  const s = stopwatches[wid];
  if(!s || !s.interval) return;
  clearInterval(s.interval);
  s.interval = null;
  s.acc += Math.floor(performance.now() - s.startTs);
}
function sw_reset(wid){
  const s = stopwatches[wid];
  if(!s) return;
  if(s.interval){ clearInterval(s.interval); s.interval = null; }
  s.acc = 0; s.startTs = 0;
  sw_updateDisplay(wid, 0);
}

/* ========= TIME-UNTIL (per-widget) ========= */
const timeUntilIntervals = {};
function spawnTimeUntil(){
  const body = createWidget('Time Until (AM/PM)');
  const wid = body.parentElement.id;
  body.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="${wid}_input" placeholder="e.g., 3:30 PM or 07:45" />
      <div style="display:flex;gap:8px">
        <button class="pill" onclick="tu_start('${wid}')">Start</button>
        <button class="pill" onclick="tu_stop('${wid}')">Stop</button>
      </div>
      <div id="${wid}_out" style="font-weight:700;margin-top:8px"></div>
    </div>
  `;
}
function parseTimeAMPM(str){
  str = (str||'').trim();
  const m = str.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM|am|pm)?$/);
  if(!m) return null;
  let hh = parseInt(m[1],10);
  let mm = m[2]? parseInt(m[2],10) : 0;
  const ampm = m[3] ? m[3].toLowerCase() : null;
  if(ampm){
    if(ampm === 'pm' && hh !== 12) hh += 12;
    if(ampm === 'am' && hh === 12) hh = 0;
  }
  return {hh,mm};
}
function tu_tick(wid, parsed){
  const out = document.getElementById(wid + '_out');
  if(!out) return;
  const now = new Date();
  const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parsed.hh, parsed.mm, 0, 0);
  if(target - now <= 0) target.setDate(target.getDate() + 1);
  const diff = target - now;
  const h = Math.floor(diff / (60*60*1000));
  const m = Math.floor(diff / (60*1000)) % 60;
  const s = Math.floor(diff / 1000) % 60;
  out.textContent = `${h}h ${m}m ${s}s (until ${('0'+((parsed.hh%12)||12)).slice(-2)}:${('0'+parsed.mm).slice(-2)} ${parsed.hh>=12? 'PM':'AM'})`;
}
function tu_start(wid){
  const inp = document.getElementById(wid + '_input');
  const out = document.getElementById(wid + '_out');
  const parsed = parseTimeAMPM(inp.value);
  if(!parsed){ out.textContent = 'Invalid time format'; return; }
  if(timeUntilIntervals[wid]) clearInterval(timeUntilIntervals[wid]);
  tu_tick(wid, parsed);
  timeUntilIntervals[wid] = setInterval(()=> tu_tick(wid, parsed), 1000);
}
function tu_stop(wid){
  if(timeUntilIntervals[wid]){ clearInterval(timeUntilIntervals[wid]); delete timeUntilIntervals[wid]; }
}

/* ========= DICE ========= */
function spawnDice(){
  const body = createWidget('Dice Roller');
  const wid = body.parentElement.id;
  body.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center">
      <select id="${wid}_type">
        <option value="6">d6</option>
        <option value="4">d4</option>
        <option value="8">d8</option>
        <option value="10">d10</option>
        <option value="12">d12</option>
        <option value="20">d20</option>
      </select>
      <input id="${wid}_count" type="number" value="1" min="1" style="width:68px" />
      <button class="pill" onclick="rollDice('${wid}')">Roll</button>
    </div>
    <div id="${wid}_out" style="margin-top:10px;font-weight:800;font-size:1.2rem"></div>
  `;
}
function rollDice(wid){
  const type = parseInt(document.getElementById(wid + '_type').value,10);
  const count = Math.max(1, Math.min(20, parseInt(document.getElementById(wid + '_count').value,10) || 1));
  const results = [];
  for(let i=0;i<count;i++) results.push(Math.floor(Math.random()*type) + 1);
  document.getElementById(wid + '_out').textContent = results.join(', ');
}

/* ========= STUDENT PICKER ========= */
function spawnStudentPicker(){
  const body = createWidget('Random Student Picker');
  const wid = body.parentElement.id;
  body.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center">
      <select id="${wid}_sel"></select>
      <button class="pill" onclick="pickRandom('${wid}')">Pick</button>
    </div>
    <div id="${wid}_res" style="margin-top:10px;font-weight:800;font-size:1.1rem;color:#0f766e"></div>
    <div class="small-muted" style="margin-top:8px">Tip: Add CSV filenames and click Load to import lists from your repo.</div>
  `;
  // populate dropdown with known filenames
  const sel = document.getElementById(wid + '_sel');
  sel.innerHTML = csvFilenames.map(f=>`<option value="${f}">${f}</option>`).join('');
}
function pickRandom(wid){
  const sel = document.getElementById(wid + '_sel');
  const res = document.getElementById(wid + '_res');
  const filename = sel.value;
  const arr = classLists[filename] || [];
  if(!arr || arr.length === 0){ res.textContent = 'No students loaded for ' + filename; return; }
  res.textContent = arr[Math.floor(Math.random()*arr.length)];
}

/* ========= UTILITY: try quick auto-check (no auto-load) ========= */
(async function tryProbe(){
  // check first CSV silently (no blocking)
  if(csvFilenames && csvFilenames.length){
    try{
      const r = await fetch(csvFilenames[0]);
      if(r.ok) console.info('Found CSV:', csvFilenames[0]);
    }catch(e){}
  }
})();
</script>
</body>
</html>
